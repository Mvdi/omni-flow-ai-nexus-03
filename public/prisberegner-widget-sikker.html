<!-- === WORDPRESS KOMPATIBEL PRISBEREGNER === -->
<!-- Kopi√©r hele denne blok ind i en WordPress side/indl√¶g eller Custom HTML block -->
<div id="prisboks-wp" style="width:100%;max-width:530px;margin:auto;font-family:'Poppins',sans-serif;background:#fff;border:1px solid #D6DBDF;box-shadow:0 2px 6px rgba(0,0,0,.05);overflow:hidden;">
  <!-- Header -->
  <div style="background:#2D4B73;color:#fff;padding:1rem;font-weight:600;font-size:1.1rem;">Algebehandling af tag</div>
  
  <!-- TRIN 1: Prisberegning -->
  <div id="trin1-wp">
    <!-- Ikoner -->
    <div style="display:flex;justify-content:space-around;padding:.75rem 1rem;font-size:.85rem;border-bottom:1px solid #eee;text-align:center;">
      <div>üßΩ<br>Stopper mos & alger</div>
      <div>üõ°Ô∏è<br>Forebygger genv√¶kst</div>
      <div>‚ú®<br>Fornyet tagoverflade</div>
    </div>
    <!-- Gul rabatboks -->
    <div style="background:#FFE86E;color:#1C1C1C;padding:.75rem 1rem;font-weight:600;text-align:center;font-size:.95rem;">
      Ved at tegne aftalen sparer du <span style="color:#00539B;font-weight:700;">200 kr.</span> p√• f√∏rste behandling!
    </div>
    <!-- Beregner -->
    <div style="padding:1rem;">
      <label for="arealValg-wp" style="display:block;font-weight:500;margin-bottom:.5rem;font-size:.95rem;">V√¶lg interval</label>
      <select id="arealValg-wp" style="width:100%;padding:.5rem;border:1px solid #ccc;border-radius:0;margin-bottom:1.25rem;">
        <option value="0">Op til 100 m¬≤</option>
        <option value="1">101‚Äë250 m¬≤</option>
        <option value="2">Over 250 m¬≤</option>
      </select>
      <label style="display:flex;align-items:flex-start;margin-bottom:1.25rem;font-weight:500;font-size:.95rem;">
        <input type="checkbox" id="vedligehold-wp" style="margin-right:8px;margin-top:4px;">Tilf√∏j √•rlig vedligeholdelsesaftale <span style="font-size:.9rem;color:#555;font-weight:400;">(Pris: <span id="vedlPris-wp">795</span> kr.)</span>
      </label>
      <div style="font-size:.85rem;margin-bottom:1.25rem;line-height:1.5;">
        Vi kan tilbyde en √•rlig serviceaftale, som inkluderer:
        <ul style="margin-top:.5rem;padding-left:1.2rem;">
          <li>√Örlig forebyggende behandling, der holder taget rent og flot.</li>
          <li>Beskytter mod genv√¶kst og forl√¶nger tagets levetid.</li>
        </ul>
        <em style="display:block;margin-top:.75rem;color:#777;font-style:italic;">F√∏rste servicebehandling finder sted i efter√•ret n√¶ste √•r og gentages hvert √•r.</em>
      </div>
      <!-- Prisfelt -->
      <div style="background:#2D4B73;color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;font-size:.95rem;margin-bottom:1rem;">
        <span style="font-weight:500;">Pris f√∏rste behandling</span>
        <span><s id="f√∏rPris-wp" style="opacity:.5;font-size:.85rem;margin-right:.5rem;">995 kr.</s><strong id="prisVisning-wp">795 kr.</strong></span>
      </div>
      <div style="text-align:center;">
        <button type="button" onclick="window.prisberegnerwp.visKundeoplysninger()" style="background:#2D4B73;color:#fff;padding:.75rem 1.1rem;font-weight:600;border:none;cursor:pointer;">N√¶ste</button>
      </div>
    </div>
  </div>

  <!-- TRIN 2: Kundeoplysninger -->
  <div id="trin2-wp" style="display:none;padding:1.5rem;">
    <div style="margin-bottom:1rem;">
      <button type="button" onclick="window.prisberegnerwp.visPrisberegning()" style="background:none;border:none;color:#2D4B73;cursor:pointer;font-size:.9rem;text-decoration:underline;">
        ‚Üê Tilbage til prisberegning
      </button>
    </div>
    
    <h3 style="margin:0 0 1rem 0;font-size:1.1rem;color:#2D4B73;">Indtast dine oplysninger</h3>
    <form id="tilbudsform-wp" onsubmit="window.prisberegnerwp.sendTilWebhook(event)" style="display:flex;flex-direction:column;gap:1rem;">
      <div style="display:flex;gap:0.5rem;">
        <input type="text" id="fornavn-wp" placeholder="Fornavn" required style="flex:1;padding:.75rem;border:1px solid #ccc;border-radius:4px;font-size:.95rem;">
        <input type="text" id="efternavn-wp" placeholder="Efternavn" required style="flex:1;padding:.75rem;border:1px solid #ccc;border-radius:4px;font-size:.95rem;">
      </div>
      <input type="email" id="email-wp" placeholder="Email" required style="padding:.75rem;border:1px solid #ccc;border-radius:4px;font-size:.95rem;">
      <input type="tel" id="telefon-wp" placeholder="Telefonnummer" required style="padding:.75rem;border:1px solid #ccc;border-radius:4px;font-size:.95rem;">
      <div style="display:flex;gap:0.5rem;">
        <input type="text" id="by-wp" placeholder="By" required style="flex:1;padding:.75rem;border:1px solid #ccc;border-radius:4px;font-size:.95rem;">
        <input type="text" id="postnummer-wp" placeholder="Postnummer" required style="flex:1;padding:.75rem;border:1px solid #ccc;border-radius:4px;font-size:.95rem;">
      </div>
      <input type="text" id="adresse-wp" placeholder="Adresse" required style="padding:.75rem;border:1px solid #ccc;border-radius:4px;font-size:.95rem;">
      <label style="display:flex;align-items:flex-start;font-size:.85rem;color:#555;gap:8px;">
        <input type="checkbox" required style="margin-top:2px;">
        Jeg har l√¶st og accepterer handelsbetingelserne
      </label>
      <button type="submit" style="background:#2D4B73;color:#fff;padding:.75rem;font-weight:600;border:none;border-radius:4px;cursor:pointer;font-size:.95rem;">Bestil tid</button>
    </form>
    <div id="besked-wp" style="margin-top:1rem;font-weight:500;font-size:.9rem;"></div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // WordPress kompatibel namespace
  window.prisberegnerwp = window.prisberegnerwp || {};
  
  let currentStep = 1;

  /* ===== Navigation mellem trin ===== */
  window.prisberegnerwp.visKundeoplysninger = function(){
    document.getElementById('trin1-wp').style.display = 'none';
    document.getElementById('trin2-wp').style.display = 'block';
    currentStep = 2;
  };

  window.prisberegnerwp.visPrisberegning = function(){
    document.getElementById('trin2-wp').style.display = 'none';
    document.getElementById('trin1-wp').style.display = 'block';
    currentStep = 1;
    // Clear any messages
    var beskedEl = document.getElementById('besked-wp');
    if (beskedEl) beskedEl.textContent = '';
  };

  /* ===== Prisberegning ===== */
  function initPrisberegning(){
    var ddl = document.getElementById('arealValg-wp');
    var chk = document.getElementById('vedligehold-wp');
    var out = document.getElementById('prisVisning-wp');
    var f√∏r = document.getElementById('f√∏rPris-wp');
    var vedlPris = document.getElementById('vedlPris-wp');
    
    if (!ddl || !chk || !out || !f√∏r || !vedlPris) return;
    
    function updatePrice(){
      var sel = ddl.value;
      var add = chk.checked;
      var std = 0, ved = 0;
      
      if(sel === '0'){
        std = 995;
        ved = 795;
        vedlPris.textContent = '795';
      } else if(sel === '1'){
        std = 1395;
        ved = 1195;
        vedlPris.textContent = '1195';
      } else {
        std = 1405;
        ved = 1203;
        vedlPris.textContent = '1203';
      }
      
      var pris = add ? ved : std;
      out.textContent = pris.toLocaleString('da-DK') + ' kr.';
      f√∏r.textContent = std.toLocaleString('da-DK') + ' kr.';
      f√∏r.style.textDecoration = add ? 'line-through' : 'none';
      f√∏r.style.opacity = add ? '.5' : '0';
    }
    
    ddl.addEventListener('change', updatePrice);
    chk.addEventListener('change', updatePrice);
    updatePrice();
  }

  /* ===== SIKKER WEBHOOK SUBMISSION ===== */
  window.prisberegnerwp.sendTilWebhook = function(e){
    e.preventDefault();
    
    var beskedEl = document.getElementById('besked-wp');
    var submitBtn = e.target.querySelector('button[type="submit"]');
    
    if (!beskedEl || !submitBtn) return;
    
    // Disable knap og vis loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sender...';
    beskedEl.textContent = '';
    
    var fornavn = document.getElementById('fornavn-wp').value.trim();
    var efternavn = document.getElementById('efternavn-wp').value.trim();
    var navn = (fornavn + ' ' + efternavn).trim();
    var email = document.getElementById('email-wp').value.trim();
    var telefon = document.getElementById('telefon-wp').value.trim();
    var adresse = document.getElementById('adresse-wp').value.trim();
    var postnummer = document.getElementById('postnummer-wp').value.trim();
    var by = document.getElementById('by-wp').value.trim();
    var fullAdresse = (adresse + ', ' + postnummer + ' ' + by).trim();
    
    var ddl = document.getElementById('arealValg-wp');
    var chk = document.getElementById('vedligehold-wp');
    var prisEl = document.getElementById('prisVisning-wp');
    
    var interval = ddl.options[ddl.selectedIndex].text;
    var vedligeholdelse = chk.checked;
    var beregnetPris = prisEl.textContent;
    
    fetch('https://tckynbgheicyqezqprdp.supabase.co/functions/v1/prisberegner-webhook', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        navn: navn,
        email: email,
        telefon: telefon,
        adresse: fullAdresse,
        interval: interval,
        vedligeholdelse: vedligeholdelse,
        beregnet_pris: beregnetPris
      })
    })
    .then(function(response) {
      return response.json();
    })
    .then(function(result) {
      if (!result.success) {
        throw new Error(result.error || 'Ukendt fejl');
      }

      beskedEl.style.color = '#2D4B73';
      beskedEl.textContent = result.message || 'Tak! Vi har modtaget din foresp√∏rgsel og vender tilbage hurtigst muligt.';
      document.getElementById('tilbudsform-wp').reset();
      
      // Reset til trin 1 efter successful submission
      setTimeout(function() {
        window.prisberegnerwp.visPrisberegning();
        document.getElementById('arealValg-wp').value = '0';
        document.getElementById('vedligehold-wp').checked = false;
        initPrisberegning(); // Re-initialize price calculation
      }, 2000);
    })
    .catch(function(error) {
      console.error('Fejl ved indsendelse:', error);
      beskedEl.style.color = '#e74c3c';
      beskedEl.textContent = 'Der opstod en fejl. Pr√∏v venligst igen.';
    })
    .finally(function() {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Bestil tid';
    });
  };

  // Initialize n√•r DOM er ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPrisberegning);
  } else {
    initPrisberegning();
  }

})();
</script>